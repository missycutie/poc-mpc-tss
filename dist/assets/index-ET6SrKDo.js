var ie=Object.defineProperty;var ce=(e,t,o)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var v=(e,t,o)=>ce(e,typeof t!="symbol"?t+"":t,o);import{I as ae,J as ue,K as S,L as de,N as le,O as fe}from"./index-DaXQJhhc.js";function me(e){return!!(e&&typeof e.then=="function")}Promise.resolve(!1);Promise.resolve(!0);const h=Promise.resolve();function P(e,t){return e||(e=0),new Promise(o=>setTimeout(()=>o(t),e))}function ge(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function _(){return Math.random().toString(36).substring(2)}let C=0;function m(){let e=Date.now()*1e3;return e<=C&&(e=C+1),C=e,e}const d=ae.getLogger("broadcast-channel");d.setLevel("error");const he=m,pe="native";function be(e){const t={time:m(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=o=>{t.messagesCallback&&t.messagesCallback(o.data)},t}function ye(e){e.bc.close(),e.subFns=[]}function we(e,t){try{return e.bc.postMessage(t,!1),h}catch(o){return Promise.reject(o)}}function _e(e,t){e.messagesCallback=t}function ke(){if(typeof window>"u")return!1;if(typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function ve(){return 150}const Me=Object.freeze(Object.defineProperty({__proto__:null,averageResponseTime:ve,canBeUsed:ke,close:ye,create:be,microSeconds:he,onMessage:_e,postMessage:we,type:pe},Symbol.toStringTag,{value:"Module"}));class E{constructor(t){v(this,"ttl");v(this,"map",new Map);v(this,"_to",!1);this.ttl=t}has(t){return this.map.has(t)}add(t){this.map.set(t,j()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Ce(this)},0))}clear(){this.map.clear()}}function Ce(e){const t=j()-e.ttl,o=e.map[Symbol.iterator]();for(;;){const n=o.next().value;if(!n)return;const s=n[0];if(n[1]<t)e.map.delete(s);else return}}function j(){return Date.now()}function M(e={}){const t=JSON.parse(JSON.stringify(e));return typeof t.webWorkerSupport>"u"&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=1e3*45),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&typeof e.idb.onclose=="function"&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=1e3*60),t.server||(t.server={}),t.server.url||(t.server.url="https://session.web3auth.io"),t.server.removeTimeout||(t.server.removeTimeout=1e3*60*5),e.methods&&(t.methods=e.methods),t}const Se=m,Pe="pubkey.broadcast-channel-0-",l="messages",b={durability:"relaxed"},Ee="idb";function T(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function k(e){e.commit&&e.commit()}function F(e){const t=T(),o=Pe+e,n=t.open(o);return n.onupgradeneeded=r=>{r.target.result.createObjectStore(l,{keyPath:"id",autoIncrement:!0})},new Promise((r,i)=>{n.onerror=c=>i(c),n.onsuccess=()=>{r(n.result)}})}function J(e,t,o){const n=Date.now(),s={uuid:t,time:n,data:o},r=e.transaction([l],"readwrite",b);return new Promise((i,c)=>{r.oncomplete=()=>i(),r.onerror=u=>c(u),r.objectStore(l).add(s),k(r)})}function Te(e){const t=e.transaction(l,"readonly",b),o=t.objectStore(l),n=[];return new Promise(s=>{o.openCursor().onsuccess=r=>{const i=r.target.result;i?(n.push(i.value),i.continue()):(k(t),s(n))}})}function K(e,t){const o=e.transaction(l,"readonly",b),n=o.objectStore(l),s=[];let r=IDBKeyRange.bound(t+1,1/0);if(n.getAll){const c=n.getAll(r);return new Promise((a,u)=>{c.onerror=g=>u(g),c.onsuccess=function(g){a(g.target.result)}})}function i(){try{return r=IDBKeyRange.bound(t+1,1/0),n.openCursor(r)}catch{return n.openCursor()}}return new Promise((c,a)=>{const u=i();u.onerror=g=>a(g),u.onsuccess=g=>{const f=g.target.result;f?f.value.id<t+1?f.continue(t+1):(s.push(f.value),f.continue()):(k(o),c(s))}})}function z(e,t){const n=e.transaction([l],"readwrite",b).objectStore(l);return Promise.all(t.map(s=>{const r=n.delete(s);return new Promise(i=>{r.onsuccess=()=>i()})}))}function V(e,t){const o=Date.now()-t,n=e.transaction(l,"readonly",b),s=n.objectStore(l),r=[];return new Promise(i=>{s.openCursor().onsuccess=c=>{const a=c.target.result;if(a){const u=a.value;if(u.time<o)r.push(u),a.continue();else{k(n),i(r);return}}else i(r)}})}function q(e,t){return V(e,t).then(o=>z(e,o.map(n=>n.id)))}function Be(e,t){return t=M(t),F(e).then(o=>{const n={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:_(),eMIs:new E(t.idb.ttl*2),writeBlockPromise:h,messagesCallback:null,readQueuePromises:[],db:o,time:m()};return o.onclose=function(){n.closed=!0,t.idb.onclose&&t.idb.onclose()},H(n),n})}function H(e){e.closed||W(e).then(()=>P(e.options.idb.fallbackInterval)).then(()=>H(e))}function Ie(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}function W(e){return e.closed||!e.messagesCallback?h:K(e.db,e.lastCursorId).then(t=>(t.filter(n=>!!n).map(n=>(n.id>e.lastCursorId&&(e.lastCursorId=n.id),n)).filter(n=>Ie(n,e)).sort((n,s)=>n.time-s.time).forEach(n=>{e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))}),h))}function Le(e){e.closed=!0,e.db.close()}function $e(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(()=>J(e.db,e.uuid,t)).then(()=>{ge(0,10)===0&&q(e.db,e.options.idb.ttl)}),e.writeBlockPromise}function De(e,t,o){e.messagesCallbackTime=o,e.messagesCallback=t,W(e)}function Ne(){return!!T()}function Oe(e){return e.idb.fallbackInterval*2}const Re=Object.freeze(Object.defineProperty({__proto__:null,TRANSACTION_SETTINGS:b,averageResponseTime:Oe,canBeUsed:Ne,cleanOldMessages:q,close:Le,commitIndexedDBTransaction:k,create:Be,createDatabase:F,getAllMessages:Te,getIdb:T,getMessagesHigherThan:K,getOldMessages:V,microSeconds:Se,onMessage:De,postMessage:$e,removeMessagesById:z,type:Ee,writeMessage:J},Symbol.toStringTag,{value:"Module"})),xe=m,Ae="pubkey.broadcastChannel-",Ue="localstorage";function B(){let e;if(typeof window>"u")return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch{}return e}function I(e){return Ae+e}function je(e,t){return new Promise(o=>{P().then(()=>{const n=I(e.channelName),s={token:_(),time:Date.now(),data:t,uuid:e.uuid},r=JSON.stringify(s);B().setItem(n,r);const i=document.createEvent("Event");i.initEvent("storage",!0,!0),i.key=n,i.newValue=r,window.dispatchEvent(i),o()})})}function X(e,t){const o=I(e),n=s=>{s.key===o&&t(JSON.parse(s.newValue))};return window.addEventListener("storage",n),n}function Y(e){window.removeEventListener("storage",e)}function Fe(e,t){if(t=M(t),!G())throw new Error("BroadcastChannel: localstorage cannot be used");const o=_(),n=new E(t.localstorage.removeTimeout),s={channelName:e,uuid:o,time:m(),eMIs:n};return s.listener=X(e,r=>{s.messagesCallback&&r.uuid!==o&&(!r.token||n.has(r.token)||r.data.time&&r.data.time<s.messagesCallbackTime||(n.add(r.token),s.messagesCallback(r.data)))}),s}function Je(e){Y(e.listener)}function Ke(e,t,o){e.messagesCallbackTime=o,e.messagesCallback=t}function G(){const e=B();if(!e)return!1;try{const t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch{return!1}return!0}function ze(){const t=navigator.userAgent.toLowerCase();return t.includes("safari")&&!t.includes("chrome")?120*2:120}const Ve=Object.freeze(Object.defineProperty({__proto__:null,addStorageEventListener:X,averageResponseTime:ze,canBeUsed:G,close:Je,create:Fe,getLocalStorage:B,microSeconds:xe,onMessage:Ke,postMessage:je,removeStorageEventListener:Y,storageKey:I,type:Ue},Symbol.toStringTag,{value:"Module"})),Q=new ue.ec("secp256k1"),N=globalThis.crypto||globalThis.msCrypto||{};N.subtle||N.webkitSubtle;const qe=Buffer.from("fffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141","hex"),He=Buffer.alloc(32,0);function p(e,t){if(!e)throw new Error(t||"Assertion failed")}function We(e){return Buffer.isBuffer(e)&&e.length===32}function Z(e){return We(e)?e.compare(He)>0&&e.compare(qe)<0:!1}const ee=function(e){return p(e.length===32,"Bad private key"),p(Z(e),"Bad private key"),Buffer.from(Q.keyFromPrivate(e).getPublic("array"))},Xe=async function(e,t){return p(e.length===32,"Bad private key"),p(Z(e),"Bad private key"),p(t.length>0,"Message should not be empty"),p(t.length<=32,"Message is too long"),Buffer.from(Q.sign(t,e,{canonical:!0}).toDER())},Ye=m,Ge="pubkey.broadcastChannel-",Qe="server";let y=null;const w=new Set;function L(e){return Ge+e}function Ze(e,t){return new Promise((o,n)=>{P().then(async()=>{const s=L(e.channelName),r=S(Buffer.from(s,"utf8")),i=await de(r.toString("hex"),{token:_(),time:Date.now(),data:t,uuid:e.uuid}),c={sameOriginCheck:!0,sameIpCheck:!0,key:ee(r).toString("hex"),data:i,signature:(await Xe(r,S(Buffer.from(i,"utf8")))).toString("hex")};return e.timeout&&(c.timeout=e.timeout),fetch(e.serverUrl+"/channel/set",{method:"POST",body:JSON.stringify(c),headers:{"Content-Type":"application/json; charset=utf-8"}}).then(o).catch(n)})})}function te(e){if(y)return y;const t=le(e,{transports:["websocket","polling"],withCredentials:!0,reconnectionDelayMax:1e4,reconnectionAttempts:10});return t.on("connect_error",o=>{t.io.opts.transports=["polling","websocket"],d.error("connect error",o)}),t.on("connect",async()=>{const{engine:o}=t.io;d.debug("initially connected to",o.transport.name),o.once("upgrade",()=>{d.debug("upgraded",o.transport.name)}),o.once("close",n=>{d.debug("connection closed",n)})}),t.on("error",o=>{d.error("socket errored",o),t.disconnect()}),y=t,t}function ne(e,t,o){const n=te(e),s=L(t.channelName),r=S(Buffer.from(s,"utf8")),i=ee(r).toString("hex");n.connected?n.emit("check_auth_status",i,{sameOriginCheck:!0,sameIpCheck:!0}):n.once("connect",()=>{d.debug("connected with socket"),n.emit("check_auth_status",i,{sameOriginCheck:!0,sameIpCheck:!0})});const c=()=>{n.once("connect",async()=>{w.has(t.channelName)&&n.emit("check_auth_status",i,{sameOriginCheck:!0,sameIpCheck:!0})})},a=()=>{if(!n||!w.has(t.channelName)){document.removeEventListener("visibilitychange",a);return}!n.connected&&document.visibilityState==="visible"&&c()},u=async g=>{try{const f=await fe(r.toString("hex"),g);d.info(f),o(f)}catch(f){d.error(f)}};return n.on("disconnect",()=>{d.debug("socket disconnected"),w.has(t.channelName)&&(d.error("socket disconnected unexpectedly, reconnecting socket"),c())}),n.on(`${i}_success`,u),typeof document<"u"&&document.addEventListener("visibilitychange",a),n}function et(){y&&y.disconnect()}function tt(e,t){t=M(t);const o=_(),n=new E(t.server.removeTimeout),s={channelName:e,uuid:o,eMIs:n,serverUrl:t.server.url,time:m()};return t.server.timeout&&(s.timeout=t.server.timeout),ne(t.server.url,s,r=>{s.messagesCallback&&r.uuid!==s.uuid&&(!r.token||s.eMIs.has(r.token)||(s.eMIs.add(r.token),s.messagesCallback(r.data)))}),w.add(e),s}function nt(e){w.delete(e.channelName)}function ot(e,t,o){e.messagesCallbackTime=o,e.messagesCallback=t}function st(){return!0}function rt(){return 500}const it=Object.freeze(Object.defineProperty({__proto__:null,averageResponseTime:rt,canBeUsed:st,close:nt,create:tt,getSocketInstance:te,microSeconds:Ye,onMessage:ot,postMessage:Ze,removeStorageEventListener:et,setupSocketConnection:ne,storageKey:L,type:Qe},Symbol.toStringTag,{value:"Module"})),ct=m,at="simulate",$=new Set,D=5;function ut(e){const t={time:m(),name:e,messagesCallback:null};return $.add(t),t}function dt(e){$.delete(e)}function lt(e,t){return new Promise(o=>setTimeout(()=>{Array.from($).forEach(s=>{s.name===e.name&&s!==e&&s.messagesCallback&&s.time<t.time&&s.messagesCallback(t)}),o()},D))}function ft(e,t){e.messagesCallback=t}function mt(){return!0}function gt(){return D}const ht=Object.freeze(Object.defineProperty({__proto__:null,SIMULATE_DELAY_TIME:D,averageResponseTime:gt,canBeUsed:mt,close:dt,create:ut,microSeconds:ct,onMessage:ft,postMessage:lt,type:at},Symbol.toStringTag,{value:"Module"})),O=[Me,Re,Ve,it];function pt(e){let t=[].concat(e.methods,O).filter(Boolean);if(e.type){if(e.type==="simulate")return ht;const n=t.find(s=>s.type===e.type);if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(n=>n.type!=="idb"));const o=t.find(n=>n.canBeUsed(e));if(o)return o;throw new Error(`No useable method found in ${JSON.stringify(O.map(n=>n.type))}`)}const oe=new Set;let bt=0;const se=function(e,t){this.id=bt++,oe.add(this),this.name=e,R&&(t=R),this.options=M(t),this.method=pt(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,yt(this)};se._pubkey=!0;let R;se.prototype={postMessage(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return x(this,"message",e)},postInternal(e){return x(this,"internal",e)},set onmessage(e){const o={time:this.method.microSeconds(),fn:e};U(this,"message",this._onML),e&&typeof e=="function"?(this._onML=o,A(this,"message",o)):this._onML=null},addEventListener(e,t){const n={time:this.method.microSeconds(),fn:t};A(this,e,n)},removeEventListener(e,t){const o=this._addEL[e].find(n=>n.fn===t);U(this,e,o)},close(){if(this.closed)return;oe.delete(this),this.closed=!0;const e=this._prepP?this._prepP:h;return this._onML=null,this._addEL.message=[],e.then(()=>Promise.all(Array.from(this._uMP))).then(()=>Promise.all(this._befC.map(t=>t()))).then(()=>this.method.close(this._state))},get type(){return this.method.type},get isClosed(){return this.closed}};function x(e,t,o){const s={time:e.method.microSeconds(),type:t,data:o};return(e._prepP?e._prepP:h).then(()=>{const i=e.method.postMessage(e._state,s);return e._uMP.add(i),i.catch().then(()=>e._uMP.delete(i)),i})}function yt(e){const t=e.method.create(e.name,e.options);me(t)?(e._prepP=t,t.then(o=>{e._state=o})):e._state=t}function re(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function A(e,t,o){e._addEL[t].push(o),wt(e)}function U(e,t,o){e._addEL[t]=e._addEL[t].filter(n=>n!==o),_t(e)}function wt(e){if(!e._iL&&re(e)){const t=n=>{e._addEL[n.type].forEach(s=>{(n.time>=s.time||e.method.type==="server")&&s.fn(n.data)})},o=e.method.microSeconds();e._prepP?e._prepP.then(()=>{e._iL=!0,e.method.onMessage(e._state,t,o)}):(e._iL=!0,e.method.onMessage(e._state,t,o))}}function _t(e){if(e._iL&&!re(e)){e._iL=!1;const t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}export{se as BroadcastChannel,Re as IndexedDbMethod,Ve as LocalstorageMethod,Me as NativeMethod,oe as OPEN_BROADCAST_CHANNELS,it as ServerMethod,pt as chooseMethod};
